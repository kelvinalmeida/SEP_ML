<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Criar Estrat√©gia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .draggable {
            cursor: grab;
        }

        .dropzone {
            border: 2px dashed #aaa;
            min-height: 150px;
            padding: 10px;
            background-color: #f8f9fa;
        }

        .sortable-item {
            cursor: move;
        }

        .order-number {
            width: 50px;
            text-align: center;
            background-color: #e9ecef;
            border-right: 1px solid #ccc;
            font-weight: bold;
        }

        .dragging {
            opacity: 0.5;
        }

        .tactic-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background-color: #e0f0ff;
            border: 1px solid #007bff;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: move;
            width: fit-content;
            max-width: 100%;
            white-space: nowrap;
        }

        .tactic-item .tactic-label {
            font-weight: 500;
            color: #333;
        }

        .dropzone {
            min-height: 200px;
            padding: 10px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container mt-5">
        <div class="card shadow p-4">
            <h2 class="mb-4">Criar Nova Estrat√©gia</h2>

            <form method="POST">
                <!-- Nome -->
                <div class="mb-3">
                    <label for="name" class="form-label">Nome da Estrat√©gia</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>

                <!-- Score (Hidden) -->
                <input type="hidden" name="score" id="scoreInput" value="0">

                <!-- T√°ticas Dispon√≠veis -->
                <div class="mb-3">
                    <label class="form-label">T√°ticas Dispon√≠veis (arraste para baixo)</label>
                    <div class="list-group">
                        <div class="list-group-item draggable" draggable="true">Reuso</div>
                        <div class="list-group-item draggable" draggable="true">Debate Sincrono</div>
                        <div class="list-group-item draggable" draggable="true">Envio de Informacao</div>
                        <div class="list-group-item draggable" draggable="true">Mudanca de Estrategia</div>
                        <div class="list-group-item draggable" draggable="true">Apresentacao Sincrona</div>
                        <div class="list-group-item draggable" draggable="true">Regra</div>
                    </div>
                </div>

                <!-- √Årea para arrastar -->
                <div class="mb-3">
                    <label class="form-label">T√°ticas Escolhidas + Tempo (min)</label>
                    <div id="dropzone" class="dropzone tactic-name"></div>
                </div>
                
                <!-- Bot√£o -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg" onclick="openAgentAnalysis()">
                        ü§ñ Validar com Agente IA
                    </button>    
                </div>

                <div id="agentModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
                    <div class="card shadow-lg" style="margin: 10% auto; padding: 2rem; width: 50%; max-width: 600px; border-radius: 15px; animation: slideIn 0.3s ease-out;">
                        <div class="text-center mb-4">
                            <h3 class="text-primary fw-bold">ü§ñ An√°lise do Agente Pedag√≥gico</h3>
                            <p class="text-muted">Consultando base de conhecimento...</p>
                        </div>
                        
                        <div id="agentLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Lendo artigos e avaliando consist√™ncia...</p>
                        </div>
    
                        <div id="agentResult" style="display:none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="h5 mb-0">Nota de Qualidade:</span>
                                <span id="agentGrade" class="display-6 fw-bold">--</span>
                            </div>
                            
                            <div class="alert alert-light border" role="alert">
                                <strong>Feedback do Especialista:</strong>
                                <p id="agentFeedback" class="mb-0 mt-2 text-dark">--</p>
                            </div>
    
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="button" class="btn btn-outline-secondary me-md-2" onclick="closeModal()">
                                    ‚úèÔ∏è Revisar e Melhorar
                                </button>
                                <button type="button" id="btnConfirm" class="btn btn-success" onclick="confirmCreation()" style="display:none;">
                                    ‚úÖ Aprovar e Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    

    

    <script>

        // --- NOVA FUN√á√ÉO: ORQUESTRA√á√ÉO DO AGENTE ---
        function openAgentAnalysis() {
            const nameInput = document.getElementById('name');
            
            // 1. Coleta dados da interface
            const strategyName = nameInput.value;
            if (!strategyName) {
                alert("Por favor, d√™ um nome √† estrat√©gia antes de validar.");
                return;
            }

            // Pega as t√°ticas que o usu√°rio arrastou para a dropzone
            const chosenTactics = Array.from(document.querySelectorAll('#dropzone .tactic-label, #dropzone .input-group-text:nth-child(3)'))
                                    .map(el => el.textContent.trim());

            if (chosenTactics.length === 0) {
                alert("Adicione pelo menos uma t√°tica.");
                return;
            }

            // 2. Abre Modal e Mostra Loading
            const modal = document.getElementById('agentModal');
            const loading = document.getElementById('agentLoading');
            const result = document.getElementById('agentResult');
            
            modal.style.display = 'block';
            loading.style.display = 'block';
            result.style.display = 'none';

            // 3. Chama o Gateway (Orquestrador)
            fetch('/strategies/orchestrate_validation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: strategyName,
                    tactics: chosenTactics
                })
            })
            .then(response => response.json())
            .then(data => {
                // 4. Exibe o Resultado do Agente
                loading.style.display = 'none';
                result.style.display = 'block';

                const gradeElem = document.getElementById('agentGrade');
                const feedbackElem = document.getElementById('agentFeedback');
                const btnConfirm = document.getElementById('btnConfirm');
                const scoreInput = document.getElementById('scoreInput');

                gradeElem.innerText = data.grade + "/10";
                feedbackElem.innerText = data.feedback;
                scoreInput.value = data.grade;

                // L√≥gica de visualiza√ß√£o baseada na nota
                if (data.grade >= 7) {
                    gradeElem.className = "display-6 fw-bold text-success";
                    btnConfirm.style.display = 'inline-block';
                } else {
                    gradeElem.className = "display-6 fw-bold text-danger";
                    // Opcional: Esconder bot√£o de confirmar se a nota for muito baixa para for√ßar revis√£o
                    btnConfirm.style.display = 'inline-block'; // Deixando livre por enquanto
                }
            })
            .catch(err => {
                console.error(err);
                loading.style.display = 'none';
                alert("Erro ao contatar o Agente Pedag√≥gico.");
                closeModal();
            });
        }

        function closeModal() {
            document.getElementById('agentModal').style.display = 'none';
        }

        function confirmCreation() {
            // Envia o formul√°rio real
            document.querySelector('form').submit();
        }
        
        // --- FIM DA FUN√á√ÉO DO AGENTE ---


        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


        let availableStrategies = [];

        // Fetch strategies on load
        fetch('/strategies/strategies_json')
            .then(r => r.json())
            .then(data => {
                availableStrategies = data;
            })
            .catch(err => console.error("Error loading strategies:", err));


        const draggables = document.querySelectorAll('.draggable');
        const dropzone = document.getElementById('dropzone');

        draggables.forEach(item => {
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.textContent);
            });
        });

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();

            const tacticName = e.dataTransfer.getData('text/plain');

            // Verifica se j√° existe a t√°tica no dropzone
            const existingTactics = Array.from(dropzone.querySelectorAll('.tactic-label'))
                .map(el => el.textContent.trim());

            if (tacticName && tacticName !== '' && !existingTactics.includes(tacticName)) {
                addTacticToDropzone(tacticName);
            }

            updateOrderNumbers();
        });


        function addTacticToDropzone(tacticName) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('input-group', 'mb-2', 'sortable-item');
            wrapper.setAttribute('draggable', 'true');

            const orderSpan = document.createElement('span');
            orderSpan.className = 'input-group-text order-number';
            orderSpan.textContent = '1¬∫';

            const inputHidden = document.createElement('input');
            inputHidden.type = 'hidden';
            inputHidden.name = 'tatics';
            inputHidden.value = tacticName;

            const tacticText = document.createElement('span');
            tacticText.className = 'input-group-text';
            tacticText.textContent = tacticName;

            const inputTime = document.createElement('input');
            inputTime.type = 'number';
            inputTime.name = 'times';
            inputTime.className = 'form-control w-10';
            inputTime.placeholder = 'Tempo (min)';
            inputTime.required = true;
            inputTime.min = '0';
            inputTime.max = '60';
            inputTime.step = '0.01';

            wrapper.appendChild(orderSpan);
            wrapper.appendChild(inputHidden);
            wrapper.appendChild(tacticText);
            wrapper.appendChild(inputTime);

            // Special handling for "Mudanca de Estrategia"
            if (tacticName === "Mudanca de Estrategia") {
                const selectStrategy = document.createElement('select');
                selectStrategy.name = 'description';
                selectStrategy.className = 'form-select w-50';
                selectStrategy.required = true;

                const defaultOpt = document.createElement('option');
                defaultOpt.value = "";
                defaultOpt.text = "Selecione a estrat√©gia de destino";
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                selectStrategy.appendChild(defaultOpt);

                availableStrategies.forEach(strat => {
                    const opt = document.createElement('option');
                    opt.value = strat.id;
                    opt.text = strat.name;
                    selectStrategy.appendChild(opt);
                });
                wrapper.appendChild(selectStrategy);

            } else {
                const inputDescription = document.createElement('input');
                inputDescription.type = 'text';
                inputDescription.name = 'description';
                inputDescription.className = 'form-control w-50';

                if (tacticName === "Apresentacao Sincrona") {
                    inputDescription.placeholder = 'Adicione o link do Google Meet ou Zoom';
                    inputDescription.required = true;
                } else {
                    inputDescription.placeholder = 'Adicione uma descri√ß√£o (opcional)';
                }
                wrapper.appendChild(inputDescription);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-outline-danger';
            deleteBtn.innerHTML = '‚úñ';
            deleteBtn.onclick = () => {
                wrapper.remove();
                updateOrderNumbers();
            };

            wrapper.appendChild(deleteBtn);
            dropzone.appendChild(wrapper);

            enableDragAndDrop();
            updateOrderNumbers();
        }


        function updateOrderNumbers() {
            const items = dropzone.querySelectorAll('.sortable-item');
            items.forEach((item, index) => {
                const span = item.querySelector('.order-number');
                span.textContent = `${index + 1}¬∫`;
            });
        }

        function enableDragAndDrop() {
            const items = dropzone.querySelectorAll('.sortable-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', (e) => {
                    item.classList.remove('dragging');
                    updateOrderNumbers();
                });
            });

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(dropzone, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;

                if (afterElement == null) {
                    dropzone.appendChild(dragging);
                } else {
                    dropzone.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    </script>

</body>

</html>